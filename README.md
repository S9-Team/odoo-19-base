# Odoo 19 - Docker Configuration

Docker configuration for Odoo 19 with external PostgreSQL database and automatic backup system to S3.

## Project Structure

```
odoo-19-base/
├── Dockerfile                      # Custom Odoo 19 image
├── docker-compose.yml              # Production configuration (ports 8069-8072)
├── docker-compose.dev.yml          # Development configuration (ports 8076-8078)
├── docker-compose.staging.yml     # Staging configuration (ports 8073-8075)
├── .env                           # Environment variables (NOT VERSIONED)
├── .gitignore                     # Files excluded from repository
├── .dockerignore                  # Files excluded from Docker image
├── scripts/                       # Automation scripts
│   ├── entrypoint.sh             # Container startup script
│   ├── create_config_file.py     # Dynamic odoo.conf generation from .env
│   ├── backup.sh                 # Database backup via HTTP
│   ├── upload_backup_to_s3.py    # Backup upload to S3
│   ├── delete_seven_days_older_backups.py  # Old backup cleanup
│   ├── run_tests.sh              # Module test execution
│   └── S3Repository.py           # Class for S3 operations handling
└── README.md                      # This file
```

### Auto-Generated Directories (NOT versioned)

The following directories are **excluded from the repository** (via `.gitignore`) because they are automatically generated during Docker build:

- **extra-addons/**: Automatically cloned from the repository configured in `GIT_REPOSITORY` during build
- **enterprise-addons/**: Automatically cloned from Odoo Enterprise (19.0 branch) during build
- **odoo.conf**: Dynamically generated by `create_config_file.py` when starting the container using `.env` variables
- **assets/**: Odoo assets directory, mounted from `/root/odoo/assets` on the host
- **backups/**: Temporary backup directory, mounted from `/root/odoo/backups` on the host

**Important**: When running `docker-compose up --build`, the Dockerfile automatically executes:
1. `git clone` of Odoo Enterprise 19.0 → `/mnt/enterprise-addons/`
2. `git clone` of custom repository (`GIT_REPOSITORY`) → `/mnt/extra-addons/`
3. On startup, `entrypoint.sh` runs `create_config_file.py` to generate `/etc/odoo/odoo.conf`

## Environment Variables (.env)

The project uses a `.env` file for configuration. Required variables:

```bash
# Application
APP_NAME="odoo_local"
APP_DOMAIN=http://localhost:8069

# PostgreSQL Database
DB_NAME=                          # Specific DB name (optional)
DB_USER=admin
DB_PASSWORD=admin
DB_HOST=host.docker.internal
DB_PORT=5432
DB_PREFIX="odoo_"                 # Prefix to filter DBs in backups
DB_FILTER="odoo\_*"               # Database filter

# Security
MASTER_PASSWORD=admin
LIST_DB=True

# GitHub (for cloning modules)
GIT_TOKEN="ghp_xxxxxxxxxxxxx"
GIT_BRANCH="main"
GIT_REPOSITORY="S9-Team/go-medical-solutions"

# AWS S3 (for backups)
S3_BUCKET_NAME="s9-cloud"
S3_ACCESS_KEY="AKIAXXXXXXXXXXXXX"
S3_SECRET_KEY="xxxxxxxxxxxxxxxxxx"
```

## Persistent Volumes

1. **odoo-data**: Odoo internal data (filestore, sessions) - Docker volume
2. **/root/odoo/assets**: Odoo shared files (`.local/share/Odoo/`) - mounted from host
3. **/root/odoo/backups**: Backup directory - mounted from host

**Note**: The `extra-addons/` and `enterprise-addons/` directories are generated inside the Docker image during build (they are not external volumes). This means they are recreated with each build and contain the most recent modules from the Git repository.


## Dockerfile - Automatic Addons Generation

The Dockerfile performs the following operations during **build**:

1. **Base**: Uses the official `odoo:19` image
2. **System dependencies**:
   - git (for cloning repositories)
   - python3-boto3 (for interacting with AWS S3)
   - postgresql-client (for database operations)
   - curl (for HTTP backups)
3. **Python dependencies**:
   - python-dotenv (for reading .env files)
4. **Automatic addon cloning** ⚠️ IMPORTANT:
   ```dockerfile
   # Clone Odoo Enterprise 19.0
   RUN git clone https://$GIT_TOKEN@github.com/odoo/enterprise.git --depth 1 --single-branch 19.0
   RUN mv 19.0/* /mnt/enterprise-addons/
   
   # Clone custom modules repository
   RUN git clone https://$GIT_TOKEN@github.com/$GIT_REPOSITORY.git -b $GIT_BRANCH /mnt/extra-addons/
   ```
   For this reason, **these directories are NOT in the repository** and are regenerated with each build.
5. **Scripts**: Copies scripts from `/scripts` to `/mnt/scripts/`
6. **Entrypoint**: Uses `entrypoint.sh` for initialization and `odoo.conf` generation

## Docker Compose - Environments

### Production (docker-compose.yml)
```bash
docker-compose up -d --build
```
**Ports**: 8069, 8071, 8072

### Development (docker-compose.dev.yml)
```bash
docker-compose -f docker-compose.dev.yml up -d --build
```
**Ports**: 8076 (HTTP), 8077 (Video/Audio), 8078 (Longpolling)

### Staging (docker-compose.staging.yml)
```bash
docker-compose -f docker-compose.staging.yml up -d --build
```
**Ports**: 8073 (HTTP), 8074 (Video/Audio), 8075 (Longpolling)

### Common Docker Compose features:
- **Build args**: Receive variables from .env (GIT_TOKEN, GIT_REPOSITORY, DB_*, etc.)
- **Container name**: odoo19
- **Volumes**:
  - `odoo-data:/var/lib/odoo` (internal data)
  - `/root/odoo/assets:/var/lib/odoo/.local/share/Odoo/` (sessions and assets)
  - `/root/odoo/backups:/mnt/backups` (backups)
  - `.env:/.env` (environment variables)
- **Extra hosts**: `host.docker.internal` to connect to PostgreSQL on the host
- **Restart policy**: unless-stopped
- **Command**: `odoo --config=/etc/odoo/odoo.conf`

## Usage Instructions

### 1. Configure Environment Variables

Create/edit `.env` file with necessary credentials (see Environment Variables section).

### 2. Build and Start Containers

**Production:**
```bash
docker-compose up -d --build
```

**Development:**
```bash
docker-compose -f docker-compose.dev.yml up -d --build
```

**Staging:**
```bash
docker-compose -f docker-compose.staging.yml up -d --build
```

### 3. View Logs

```bash
docker-compose logs -f odoo
# or
docker logs -f odoo19
```

### 4. Stop Containers

```bash
docker-compose down
```

### 5. Restart Odoo

```bash
docker-compose restart odoo
# or
docker restart odoo19
```

### 6. Access Odoo

Depending on environment:
- **Production**: http://localhost:8069
- **Development**: http://localhost:8076
- **Staging**: http://localhost:8073

## Automation Scripts

### entrypoint.sh
Startup script that runs when the container starts:
- Verifies root permissions
- Runs `create_config_file.py` to generate `/etc/odoo/odoo.conf` from .env variables
- Creates sessions directory
- Configures backup permissions
- Starts Odoo as `odoo` user

### create_config_file.py
Dynamically generates the `odoo.conf` file from environment variables:
- Reads variables from `/.env`
- Configures: db_host, db_port, db_user, db_password, db_name, dbfilter, addons_path, list_db
- Overwrites `/etc/odoo/odoo.conf`

### backup.sh
Script for PostgreSQL database backup:
- Loads variables from `/.env`
- Connects to PostgreSQL and lists all databases matching DB_PREFIX
- Performs backup via HTTP using Odoo API (`/web/database/backup`)
- Saves ZIP files in `/mnt/backups/`
- Names files with format: `{DB_NAME}_{YYYY-MM-DD_HHMMSS}.zip`

**Usage:**
```bash
docker exec odoo19 /mnt/scripts/backup.sh
```

### upload_backup_to_s3.py
Uploads local backups to AWS S3:
- Reads S3 configuration from `.env` (S3_BUCKET_NAME, S3_ACCESS_KEY, S3_SECRET_KEY)
- Uploads files from `/mnt/backups/` to S3
- Organizes in path: `/odoo/backups/{APP_NAME}/`
- Renames uploaded local files with `bk_` prefix to avoid duplicates
- Deletes previous files with `bk_` prefix

**Usage:**
```bash
docker exec odoo19 python3 /mnt/scripts/upload_backup_to_s3.py
```

### delete_seven_days_older_backups.py
Cleans up old local backups:
- Analyzes files in `/mnt/backups/`
- Extracts date from filename
- Deletes files older than 7 days

**Usage:**
```bash
docker exec odoo19 python3 /mnt/scripts/delete_seven_days_older_backups.py
```

### run_tests.sh
Runs Odoo module tests:
- Parameter 1: Module name (default: `web_m2x_options`)
- Parameter 2: Database name (default: `odoo19`)
- Runs tests with `--test-enable`, `--stop-after-init`, `--workers=0`
- Shows results with emojis ✅/❌

**Usage:**
```bash
./scripts/run_tests.sh <module_name> [database_name]

# Example:
./scripts/run_tests.sh base_tier_validation odoo19
```

### S3Repository.py
Python class for AWS S3 operations:
- Constructor: Receives bucket_name, access_key, secret_key
- Method `upload()`: Uploads local file to S3
- Error handling: S3UploadFailedError, ClientError

## odoo.conf Configuration

**Important note**: The `odoo.conf` file is **NOT versioned** in the repository. It is dynamically generated when starting the container through the `create_config_file.py` script, which reads environment variables from `.env`.

The generated configuration contains:

```ini
[options]
# Database
db_host = host.docker.internal
db_port = 5432
db_user = admin
db_password = admin
db_sslmode = prefer
dbfilter = ^odoo_*

# Addon paths
addons_path = /usr/lib/python3/dist-packages/odoo/addons,/mnt/extra-addons,/mnt/enterprise-addons

# Server
http_port = 8069
gevent_port = 8072

# Workers
workers = 2
max_cron_threads = 1

# Memory limits
limit_memory_hard = 2684354560
limit_memory_soft = 2147483648
limit_request = 8192
limit_time_cpu = 600
limit_time_real = 1200
limit_time_real_cron = 1200

# Logs
log_level = info
log_handler = :INFO

# Security
admin_passwd = admin
list_db = True

# Without demo data
without_demo = True
```

**Note**: The file is overwritten by `create_config_file.py` when starting the container, using values from `.env`.

## Custom Modules

**Note**: These modules are automatically cloned from the repository configured in `GIT_REPOSITORY` during Docker build. They are NOT included in this repository.

Modules available in the remote repository:

- **account_move_tier_validation**: Tier validation for accounting moves
- **account_move_tier_validation_approver**: Approvers for move validation
- **account_partner_company_group**: Company grouping for accounting
- **base_partner_company_group**: Base company grouping
- **base_tier_validation**: Base tier validation system
- **base_user_role**: User roles
- **base_user_role_company**: Company-based roles
- **crm_partner_company_group**: Company grouping for CRM
- **elevated_19_issues_fixes**: Specific fixes for Odoo 19
- **partner_client_id**: Client ID for partners
- **partner_company_group**: Company grouping
- **project_task_stock**: Task and inventory integration
- **purchase_tier_validation**: Tier validation for purchases
- **sale_partner_company_group**: Company grouping for sales
- **sale_tier_validation**: Tier validation for sales
- **stock_no_negative**: Prevent negative inventory
- **web_environment_ribbon**: Visual environment ribbon
- **web_m2x_options**: Options for many2many/many2one fields

## Adding New Modules

### Standard workflow:

Modules are automatically cloned from the Git repository configured in `GIT_REPOSITORY`. To add new modules:

1. **Add to remote Git repository**: 
   - Commit and push the new module to the configured repository (e.g., S9-Team/go-medical-solutions)
   - Ensure it's on the branch specified in `GIT_BRANCH`

2. **Rebuild Docker image**:
   ```bash
   docker-compose down
   docker-compose up -d --build
   ```
   The build will clone the repository again with the most recent changes.

3. **Update application list**: In Odoo → Apps → Update Apps List

4. **Install**: Search and install the new module

### Local development (without rebuild):

For quick development without rebuilding the image:

```bash
# Copy module directly to container
docker cp my_module/ odoo19:/mnt/extra-addons/
docker restart odoo19
```

⚠️ **Warning**: Local changes will be lost when rebuilding the image. Always commit changes to the Git repository.

## Exposed Ports

### Production (docker-compose.yml):
- **8069**: Main HTTP port
- **8071**: Video/audio streaming
- **8072**: Longpolling (real-time chat)

### Development (docker-compose.dev.yml):
- **8076**: Main HTTP port
- **8077**: Video/audio streaming  
- **8078**: Longpolling

### Staging (docker-compose.staging.yml):
- **8073**: Main HTTP port
- **8074**: Video/audio streaming
- **8075**: Longpolling

## Troubleshooting

### Cannot connect to database

Verify:
1. PostgreSQL is running on the host
2. Credentials in `.env` are correct
3. User has permissions in PostgreSQL
4. `host.docker.internal` is available (works on Docker Desktop, on Linux may require `--add-host`)

### Modules don't appear

1. Verify that GIT_TOKEN and GIT_REPOSITORY are correct
2. Rebuild the image: `docker-compose up -d --build`
3. Check logs: `docker logs odoo19`
4. Update application list in Odoo

### Permission errors

The entrypoint automatically configures permissions. If problems persist:

```bash
# On the host
sudo chown -R 101:101 /root/odoo/assets
sudo chown -R 101:101 /root/odoo/backups
```

### Backup fails

Verify:
1. `MASTER_PASSWORD` in `.env` matches the one configured in Odoo
2. `APP_DOMAIN` is accessible from the container
3. `/mnt/backups` directory has write permissions

```bash
docker exec odoo19 ls -la /mnt/backups
```

### S3 upload fails

Verify:
1. S3 credentials in `.env` are correct
2. Bucket exists and is accessible
3. IAM policies allow `s3:PutObject`

```bash
docker exec odoo19 python3 /mnt/scripts/upload_backup_to_s3.py
```

## Useful Commands

### View logs in real-time
```bash
docker logs -f odoo19
```

### Access container
```bash
docker exec -it odoo19 bash
```

### Update modules
```bash
docker exec odoo19 odoo -u <module_name> -d <database_name> --stop-after-init
```

### Python Shell in Odoo
```bash
docker exec -it odoo19 odoo shell -d <database_name>
```

### List databases
```bash
docker exec odoo19 psql -h host.docker.internal -U admin -d postgres -c "SELECT datname FROM pg_database;"
```

### Run backup manually
```bash
docker exec odoo19 /mnt/scripts/backup.sh
```

### Upload backups to S3
```bash
docker exec odoo19 python3 /mnt/scripts/upload_backup_to_s3.py
```

### Clean old backups
```bash
docker exec odoo19 python3 /mnt/scripts/delete_seven_days_older_backups.py
```

### View Odoo help
```bash
docker exec odoo19 odoo --help
```

## Backups and Restoration

### Create manual backup

**Option 1: Via Script**
```bash
docker exec odoo19 /mnt/scripts/backup.sh
```

**Option 2: Via web interface**
- Navigate to: http://localhost:8069/web/database/manager
- Use configured master password
- Select database and download backup

**Option 3: Via PostgreSQL directly**
```bash
docker exec odoo19 pg_dump -h host.docker.internal -U admin -d odoo19 -F c -b -v -f /mnt/backups/manual_backup.dump
```

### Restore backup

**Via web interface:**
1. Go to http://localhost:8069/web/database/manager
2. Use master password
3. Create new database or restore over existing one

**Via command line:**
```bash
docker exec odoo19 pg_restore -h host.docker.internal -U admin -d odoo19_restored -v /mnt/backups/backup_file.dump
```

### Backup automation

To automate daily backups, configure cron on the host:

```bash
# Edit crontab
crontab -e

# Add line for daily backup at 2 AM
0 2 * * * docker exec odoo19 /mnt/scripts/backup.sh && docker exec odoo19 python3 /mnt/scripts/upload_backup_to_s3.py

# Weekly cleanup on Sundays at 3 AM
0 3 * * 0 docker exec odoo19 python3 /mnt/scripts/delete_seven_days_older_backups.py
```

## Security and Best Practices

### Production

⚠️ **This configuration is for development. For production:**

1. **Change master password**: Modify in `.env` and `odoo.conf`
2. **Use HTTPS**: Configure reverse proxy (nginx, traefik)
3. **Protect .env**: 
   ```bash
   chmod 600 .env
   ```
4. **Disable DB listing**: `LIST_DB=False` in `.env`
5. **Strict DB filter**: Configure `DB_FILTER` appropriately
6. **Secure credentials**: Use secrets management (AWS Secrets Manager, Vault)
7. **Token rotation**: Regenerate GIT_TOKEN and S3 credentials periodically
8. **Firewall**: Restrict exposed ports only to known IPs
9. **Regular updates**: Keep Odoo and dependencies updated
10. **Monitoring**: Implement logging and alerts

### Sensitive variables

The following variables **should NOT be versioned**:
- GIT_TOKEN
- DB_PASSWORD  
- MASTER_PASSWORD
- S3_ACCESS_KEY
- S3_SECRET_KEY

The `.env` file is included in `.gitignore`.

## System Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                         Host Machine                         │
│  ┌──────────────────┐                                        │
│  │   PostgreSQL     │                                        │
│  │   (External DB)  │◄─────────────────┐                    │
│  └──────────────────┘                   │                    │
│                                          │                    │
│  ┌────────────────────────────────────┐ │                    │
│  │     Docker Container: odoo19       │ │                    │
│  │  ┌──────────────────────────────┐  │ │                    │
│  │  │  Odoo 19 Application         │  │ │                    │
│  │  │  - Port 8069/8073/8076 (HTTP)│◄─┼─┼──── Users          │
│  │  │  - Port 8071/8074/8077       │  │ │                    │
│  │  │  - Port 8072/8075/8078       │  │ │                    │
│  │  └──────────────────────────────┘  │ │                    │
│  │           │          ▲               │ │                    │
│  │           │          │               │ │                    │
│  │           ▼          │               │ │                    │
│  │  ┌──────────────────────────────┐  │ │                    │
│  │  │  /mnt/extra-addons/         │  │ │                    │
│  │  │  (Custom Modules from Git)   │  │ │                    │
│  │  └──────────────────────────────┘  │ │                    │
│  │  ┌──────────────────────────────┐  │ │                    │
│  │  │  /mnt/enterprise-addons/     │  │ │                    │
│  │  │  (Enterprise Modules)        │  │ │                    │
│  │  └──────────────────────────────┘  │ │                    │
│  │  ┌──────────────────────────────┐  │ │                    │
│  │  │  /mnt/scripts/               │  │ │                    │
│  │  │  - entrypoint.sh             │  │ │                    │
│  │  │  - backup.sh ────────────────┼──┘ │                    │
│  │  │  - upload_backup_to_s3.py ───┼────┼──► AWS S3          │
│  │  │  - create_config_file.py     │    │                    │
│  │  │  - run_tests.sh              │    │                    │
│  │  └──────────────────────────────┘    │                    │
│  │  ┌──────────────────────────────┐    │                    │
│  │  │  /mnt/backups/               │◄───┼─ /root/odoo/      │
│  │  │  (Backup files)              │    │    backups/        │
│  │  └──────────────────────────────┘    │                    │
│  └────────────────────────────────────┘                    │
└─────────────────────────────────────────────────────────────┘
```

## Notas Importantes

## Important Notes

- **Master password**: The default master password is "admin". **MUST be changed in production**.
- **Git tokens**: GIT_TOKEN is used to clone private repositories. Ensure it has read permissions.
- **External host**: Docker-compose files map `/root/odoo/assets` and `/root/odoo/backups` from the host. Ensure these directories exist.
- **Performance**: Adjust `workers` in `odoo.conf` according to server resources (CPU cores).
- **Memory limits**: Configured for ~2.5GB, adjust according to availability.
- **Automatic cloning**: Addons are cloned during build. Repository changes require `--build`.
- **No demo data**: Configuration uses `without_demo = True`.
- **Dynamic configuration**: `odoo.conf` is dynamically generated from `.env` on each startup.

## Additional Resources

- [Official Odoo 19 Documentation](https://www.odoo.com/documentation/19.0/)
- [Odoo Docker Hub](https://hub.docker.com/_/odoo)
- [Project GitHub Repository](https://github.com/S9-Team/go-medical-solutions)

## Support and Contributions

To report issues or suggestions, contact the development team.

---

## About

**Developed by**: [Elevated Business Consulting](https://www.elevatedbusiness.consulting/)  
**Version**: Odoo 19  
**Last updated**: January 2026  
**Maintained by**: S9 Team

<div align="center">
  
### Elevated Business Consulting
*Empowering your business through innovative solutions*

**Website**: [www.elevatedbusiness.consulting](https://www.elevatedbusiness.consulting/)

---

© 2026 Elevated Business Consulting. All rights reserved.

</div>